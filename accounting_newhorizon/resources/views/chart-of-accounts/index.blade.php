@extends('layouts.app')

@section('content')
<main class="flex-1 p-8 overflow-y-auto">

    <!-- ุงูููุฏุฑ -->
    <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
        <div>
            <h1 class="text-3xl font-extrabold text-primary">
                <i class="fas fa-sitemap ml-3 text-secondary"></i> ุดุฌุฑุฉ ุงูุญุณุงุจุงุช
            </h1>
            <p class="text-sm text-gray-500 mt-1">ุงุณุชุฎุฏู ุงูููุงุชุฑ ุฃุฏูุงู ูุชุตููุฉ ุงูุฌุฏููุ ููููู ุชุทุจูููุง ุนูู ุงูุดุฌุฑุฉ ุฏูู ุฅุนุงุฏุฉ ุชุญููู.</p>
        </div>

        <div class="flex space-x-3 space-x-reverse">
            <a href="{{ route('chart-of-accounts.export') }}"
                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-medium">
                <i class="fas fa-file-excel ml-2"></i> ุชุตุฏูุฑ Excel
            </a>

            <button type="button" onclick="document.getElementById('importModal').classList.remove('hidden')"
                class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition font-medium flex items-center">
                <i class="fas fa-upload ml-2"></i> ุงุณุชูุฑุงุฏ Excel
            </button>

            <button id="toggleView"
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium">
                <i class="fas fa-exchange-alt ml-2"></i> ุชุจุฏูู ุงูุนุฑุถ
            </button>

            <a href="{{ route('chart-of-accounts.create', ['view' => request('view', 'table')]) }}"
                class="px-4 py-2 bg-secondary text-primary rounded-lg hover:bg-secondary/90 transition font-medium">
                <i class="fas fa-plus ml-2"></i> ุฅุถุงูุฉ ุญุณุงุจ
            </a>
        </div>
    </header>

    <!-- ุจุทุงูุงุช ุฅุญุตุงุฆูุงุช (ุญุณุจ ุงูููุงุชุฑ) -->
    <section class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
        <x-stat-card title="ุฅุฌูุงูู" :value="$stats['total']" icon="fa-layer-group" color="blue" />
        <x-stat-card title="ุงูุฑุฆูุณู" :value="$stats['groups']" icon="fa-folder-tree" color="purple" />
        <x-stat-card title="ุงููุฑุนูุฉ" :value="$stats['leaves']" icon="fa-file-invoice" color="yellow" />
        <x-stat-card title="ูุดุท" :value="$stats['active']" icon="fa-check-circle" color="green" />
        <x-stat-card title="ุบูุฑ ูุดุท" :value="$stats['inactive']" icon="fa-ban" color="red" />
        <x-stat-card title="ูุฏูู/ุฏุงุฆู" :value="$stats['debit'].' / '.$stats['credit']" icon="fa-balance-scale" color="teal" />

    </section>


    <!-- ููุงุชุฑ -->
    <form id="filtersForm" method="GET" action="{{ route('chart-of-accounts.index') }}" class="bg-white rounded-xl shadow p-4 mb-6">
        <div class="grid md:grid-cols-6 gap-4">
            <div class="md:col-span-2">
                <label class="block text-sm mb-1">ุจุญุซ (ููุฏ/ุงุณู/ูุตู)</label>
                <input type="text" name="q" value="{{ $filters['q'] }}" class="w-full border rounded-lg px-3 py-2" placeholder="ูุซุงู: 1101 ุฃู ุฎุฒููุฉ">
            </div>

            <div>
                <label class="block text-sm mb-1">ุงูุญุงูุฉ</label>
                <select name="status" class="w-full border rounded-lg px-3 py-2">
                    <option value="">ุงููู</option>
                    <option value="ูุดุท" {{ $filters['status']==='ูุดุท' ? 'selected' : '' }}>ูุดุท</option>
                    <option value="ุบูุฑ ูุดุท" {{ $filters['status']==='ุบูุฑ ูุดุท' ? 'selected' : '' }}>ุบูุฑ ูุดุท</option>
                </select>
            </div>

            <div>
                <label class="block text-sm mb-1">ุทุจูุนุฉ ุงูุญุณุงุจ</label>
                <select name="nature" class="w-full border rounded-lg px-3 py-2">
                    <option value="">ุงููู</option>
                    <option value="debit" {{ $filters['nature']==='debit' ? 'selected' : '' }}>ูุฏูู</option>
                    <option value="credit" {{ $filters['nature']==='credit' ? 'selected' : '' }}>ุฏุงุฆู</option>
                </select>
            </div>

            <div>
                <label class="block text-sm mb-1">ููุน ุงูุญุณุงุจ</label>
                <select name="account_type_id" class="w-full border rounded-lg px-3 py-2">
                    <option value="">ุงููู</option>
                    @foreach($accountTypes as $t)
                    <option value="{{ $t->id }}" {{ (string)$filters['account_type_id']===(string)$t->id ? 'selected' : '' }}>
                        {{ $t->name }}
                    </option>
                    @endforeach
                </select>
            </div>

            <div>
                <label class="block text-sm mb-1">ุงูุนููุฉ</label>
                <select name="currency_id" class="w-full border rounded-lg px-3 py-2">
                    <option value="">ุงููู</option>
                    @foreach($currencies as $c)
                    <option value="{{ $c->id }}" {{ (string)$filters['currency_id']===(string)$c->id ? 'selected' : '' }}>
                        {{ $c->code }} - {{ $c->name }}
                    </option>
                    @endforeach
                </select>
            </div>

            <div>
                <label class="block text-sm mb-1">ูู ูุฌููุนุฉุ</label>
                <select name="is_group" class="w-full border rounded-lg px-3 py-2">
                    <option value="">ุงููู</option>
                    <option value="1" {{ $filters['is_group']==='1' ? 'selected' : '' }}>ุฑุฆูุณู</option>
                    <option value="0" {{ $filters['is_group']==='0' ? 'selected' : '' }}>ูุฑุนู</option>
                </select>
            </div>
        </div>

        <div class="mt-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button class="px-4 py-2 bg-secondary text-primary rounded-lg hover:bg-secondary/90"><i class="fas fa-filter ml-2"></i> ุชุทุจูู ุนูู ุงูุฌุฏูู</button>
                <!-- <button type="button" id="applyToTree" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                    <i class="fas fa-tree ml-2"></i> ุชุทุจูู ุงูููุงุชุฑ ุนูู ุงูุดุฌุฑุฉ (ุจุฏูู ุชุญุฏูุซ)
                </button> -->
                <a href="{{ route('chart-of-accounts.index', ['view' => $viewMode]) }}" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100">
                    ูุณุญ ุงูููุงุชุฑ
                </a>
            </div>
            <label class="inline-flex items-center gap-2 text-sm text-gray-600">
                <input type="checkbox" id="autoSubmit" checked>
                <span>ุชุทุจูู ุชููุงุฆู ุนูุฏ ุชุบููุฑ ุงูุญููู</span>
            </label>
        </div>
    </form>

    <!-- ููุฏุงู ุงูุงุณุชูุฑุงุฏ -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg w-1/3 p-6">
            <h2 class="text-lg font-bold mb-4">๐ ุงุณุชูุฑุงุฏ ููู ุงูุญุณุงุจุงุช</h2>
            <form action="{{ route('chart-of-accounts.import') }}" method="POST" enctype="multipart/form-data">
                @csrf
                <input type="file" name="file" accept=".xlsx,.xls,.csv" class="mb-4 w-full border p-2 rounded">
                <div class="flex justify-end space-x-2 space-x-reverse">
                    <button type="button" onclick="document.getElementById('importModal').classList.add('hidden')"
                        class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">ุฅูุบุงุก</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ุงุณุชูุฑุงุฏ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- โ ุนุฑุถ ุฌุฏููู -->
    <div id="tableView" class="bg-white rounded-xl shadow-lg overflow-hidden {{ $viewMode==='tree' ? 'hidden' : '' }}">
        @if(session('success'))
        <div class="bg-green-100 text-green-700 p-3 rounded mb-4">{{ session('success') }}</div>
        @endif
        @if(session('info'))
        <div class="bg-blue-100 text-blue-700 p-3 rounded mb-4">{{ session('info') }}</div>
        @endif

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">ุงูููุฏ</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">ุงุณู ุงูุญุณุงุจ</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">ุงูููุน</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">ุงูุทุจูุนุฉ</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">ุงูุญุงูุฉ</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ุงูุฅุฌุฑุงุกุงุช</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @forelse($accountsTable as $account)
                    <tr class="hover:bg-gray-50 transition duration-150 {{ $account->trashed() ? 'opacity-60' : '' }} {{ !$account->is_group ? 'bg-yellow-50' : '' }}">
                        <td class="px-6 py-4 whitespace-nowrap font-bold">{{ $account->code }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            @if($account->parent)
                            <span class="text-gray-500 text-sm">({{ $account->parent->name }}) โ </span>
                            @endif
                            {{ $account->name }}
                        </td>
                        <td class="px-6 py-4">{{ $account->accountType->name ?? '---' }}</td>
                        <td class="px-6 py-4">{{ $account->nature === 'debit' ? 'ูุฏูู' : 'ุฏุงุฆู' }}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                    {{ $account->status == 'ูุดุท' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' }}">
                                {{ $account->status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center text-sm font-medium">
                            <a href="{{ route('chart-of-accounts.edit', $account->id) }}" class="text-secondary hover:text-primary ml-3">
                                <i class="fas fa-edit"></i> ุชุนุฏูู
                            </a>
                            <form action="{{ route('chart-of-accounts.destroy', $account->id) }}" method="POST" class="inline" onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุญุณุงุจุ')">
                                @csrf @method('DELETE')
                                <button type="submit" class="text-red-600 hover:text-red-900 mr-3">
                                    <i class="fas fa-trash"></i> ุญุฐู
                                </button>
                            </form>
                        </td>
                    </tr>
                    @empty
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุทุงุจูุฉ.</td>
                    </tr>
                    @endforelse
                </tbody>
            </table>
        </div>

        <div class="px-6 py-4 bg-gray-50">
            {{ $accountsTable->links() }}
        </div>
    </div>

    <!-- โ ุนุฑุถ ูุฑูู (ุดุฌุฑุฉ) โ ุจุฏูู Pagination -->
    <div id="treeView" class="bg-white rounded-xl shadow-lg p-6 {{ $viewMode==='tree' ? '' : 'hidden' }}">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold"><i class="fas fa-tree ml-2 text-green-600"></i> ุงูุนุฑุถ ุงููุฑูู</h2>
            <button id="toggleAllBtn" class="px-4 py-2 bg-secondary text-primary rounded-lg hover:bg-secondary/90 transition font-medium shadow">
                <i class="fas fa-minus-square ml-2"></i> ุทู ุงููู
            </button>
        </div>

        <ul class="space-y-2" id="treeRootUl">
            @foreach($treeRoots as $root)
            @include('chart-of-accounts.tree_node', ['account' => $root])
            @endforeach
        </ul>
        <div id="treeNoMatch" class="hidden text-center text-gray-500 mt-6">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุทุงุจูุฉ ูู ุงูุดุฌุฑุฉ ุจุนุฏ ุชุทุจูู ุงูููุงุชุฑ.</div>
    </div>
</main>

<!-- ููุฏุงู ุงูุฅุถุงูุฉ (ููุง ูู ูุฏูู) -->
@include('chart-of-accounts._add_modal')

@endsection


<script>
    document.addEventListener('DOMContentLoaded', function() {
        /* ======================== Helpers ======================== */
        const qs = (sel, root = document) => root.querySelector(sel);
        const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));
        const on = (el, ev, fn) => el && el.addEventListener(ev, fn);

        function getCsrf() {
            // 1) ูู meta (ุฅู ูุฌุฏ)
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) return meta.getAttribute('content');
            // 2) ูู Blade ูุชุบูุฑ
            try {
                return "{{ csrf_token() }}";
            } catch (_) {}
            // 3) ูู ุฃูู input[name=_token]
            const t = document.querySelector('input[name=_token]');
            return t ? t.value : '';
        }

        async function fetchJSON(url, opts = {}) {
            const res = await fetch(url, opts);
            const ct = res.headers.get('content-type') || '';
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return ct.includes('application/json') ? res.json() : res.text();
        }

        function updateURLParam(key, val) {
            try {
                const url = new URL(window.location);
                url.searchParams.set(key, val);
                window.history.replaceState({}, '', url);
            } catch (_) {}
        }

        /* ======================== ุนูุงุตุฑ ุฃุณุงุณูุฉ ======================== */
        const toggleBtn = qs('#toggleView');
        const tableView = qs('#tableView');
        const treeView = qs('#treeView');

        const filtersForm = qs('#filtersForm');
        const autoSubmit = qs('#autoSubmit');
        //const applyToTreeBtn = qs('#applyToTree');

        const treeRootUl = qs('#treeRootUl');
        const treeNoMatch = qs('#treeNoMatch');
        const toggleAllBtn = qs('#toggleAllBtn');

        // ุนูุงุตุฑ ุงูููุฏุงู
        const addModal = qs('#addAccountModal');
        const addForm = qs('#addAccountForm');
        const codeInput = qs('#code_modal');
        const nameInput = qs('#name_modal');
        const isGroupCheckbox = qs('#is_group_modal');
        const parentSelect = qs('#parent_id_modal_select');
        const accountTypeWrap = qs('#accountTypeWrapper_modal');
        const accountTypeSel = qs('#account_type_id_modal');
        const natureWrap = qs('#natureWrapper_modal');
        const natureSel = qs('#nature_modal');
        const statusSel = qs('#status_modal');
        const currencySel = qs('#currency_id_modal');

        /* ======================== ุชุจุฏูู ุงูุนุฑุถ (ุฌุฏูู/ุดุฌุฑุฉ) ======================== */
        // ุงุถุจุท ุงูุญุงูุฉ ุงูุงุจุชุฏุงุฆูุฉ ูู ?view=...
        (function initViewFromURL() {
            if (!tableView || !treeView) return;
            try {
                const url = new URL(window.location);
                const current = url.searchParams.get('view'); // table | tree
                if (current === 'tree') {
                    tableView.classList.add('hidden');
                    treeView.classList.remove('hidden');
                } else if (current === 'table') {
                    tableView.classList.remove('hidden');
                    treeView.classList.add('hidden');
                }
            } catch (_) {}
        })();

        on(toggleBtn, 'click', function(e) {
            e.preventDefault();
            if (!tableView || !treeView) return;
            tableView.classList.toggle('hidden');
            treeView.classList.toggle('hidden');
            const mode = treeView.classList.contains('hidden') ? 'table' : 'tree';
            updateURLParam('view', mode);
        });



        /* ======================== ููุงุชุฑ ุงูุดุฌุฑุฉ (ุจุฏูู ุฑูุฑุด) ======================== */
        function applyFiltersToTree() {
            if (!treeRootUl) return;

            const getVal = name => (qs(`[name="${name}"]`, filtersForm)?.value ?? '').trim();
            const q = (getVal('q') || '').toLowerCase();
            const status = getVal('status'); // 'ูุดุท' | 'ุบูุฑ ูุดุท' | ''
            const nature = getVal('nature'); // 'debit' | 'credit' | ''
            const is_group = getVal('is_group'); // '1' | '0' | ''
            const typeId = getVal('account_type_id');
            const currencyId = getVal('currency_id');

            const nodes = qsa('li[data-id]', treeRootUl);
            nodes.forEach(li => {
                const d = li.dataset;
                let ok = true;

                if (q) {
                    const txt = ((d.code || '') + ' ' + (d.name || '') + ' ' + (d.desc || '')).toLowerCase();
                    ok = ok && txt.includes(q);
                }
                if (status) ok = ok && (d.status === status);
                if (nature) ok = ok && (d.nature === nature);
                if (is_group !== '') ok = ok && (d.is_group === is_group);
                if (typeId) ok = ok && (d.type_id === typeId);
                if (currencyId) ok = ok && (d.currency_id === currencyId);

                li.classList.toggle('hidden-by-filter', !ok);
            });

            // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุง ููุฌุฏ ูุชุงุฆุฌ / ูุฅุธูุงุฑ ุณูุงู ุงูุขุจุงุก ููุนููุฏ ุงููุทุงุจูุฉ
            const anyVisible = !!qs('li[data-id]:not(.hidden-by-filter)', treeRootUl);
            if (treeNoMatch) treeNoMatch.classList.toggle('hidden', anyVisible);
            revealAncestorsForVisible();
        }

        function revealAncestorsForVisible() {
            const visibles = qsa('#treeRootUl li[data-id]:not(.hidden-by-filter)');
            visibles.forEach(li => {
                let parentUl = li.parentElement;
                while (parentUl && parentUl.id && parentUl.id.startsWith('children-')) {
                    parentUl.classList.remove('hidden'); // ุงูุชุญ ูุฑุน ุงูุฃุจ
                    const parentLi = parentUl.parentElement; // li ุงูุฃุจ
                    if (parentLi) {
                        const tgl = qs('.toggle-children', parentLi);
                        if (tgl) tgl.innerHTML = '<i class="fas fa-minus-square"></i>';
                    }
                    parentUl = parentLi ? parentLi.parentElement : null;
                }
            });
        }


        /* ======================== ุทู/ุชูุณูุน ุงูุดุฌุฑุฉ ======================== */
        // ุฃุฒุฑุงุฑ ุงูุทู/ุงูุชูุณูุน ุงููุฑุฏู ููุฌูุฏุฉ ุฏุงุฎู ูู node (class="toggle-children")
        function bindNodeToggleButtons(scope = document) {
            qsa('.toggle-children', scope).forEach(btn => {
                on(btn, 'click', function() {
                    const targetId = this.dataset.target;
                    const ul = targetId ? qs('#' + targetId) : null;
                    if (!ul) return;
                    const isHidden = ul.classList.toggle('hidden');
                    this.innerHTML = isHidden ? '<i class="fas fa-plus-square"></i>' :
                        '<i class="fas fa-minus-square"></i>';
                });
            });
        }
        bindNodeToggleButtons();

        // ุฒุฑ ุทู/ุชูุณูุน ุงููู
        let expanded = true; // ุงูุชุฑุงุถู: ููุชูุญ
        on(toggleAllBtn, 'click', function() {
            const allChildren = qsa("ul[id^='children-']");
            const allToggles = qsa(".toggle-children");
            expanded = !expanded;
            if (expanded) {
                allChildren.forEach(ul => ul.classList.remove('hidden'));
                allToggles.forEach(b => b.innerHTML = '<i class="fas fa-minus-square"></i>');
                this.innerHTML = '<i class="fas fa-minus-square ml-2"></i> ุทู ุงููู';
            } else {
                allChildren.forEach(ul => ul.classList.add('hidden'));
                allToggles.forEach(b => b.innerHTML = '<i class="fas fa-plus-square"></i>');
                this.innerHTML = '<i class="fas fa-plus-square ml-2"></i> ุชูุณูุน ุงููู';
            }
        });

        /* ======================== ููุฏุงู ุฅุถุงูุฉ ุญุณุงุจ ======================== */
        function openModal(parentId = null) {
            if (!addModal) return;
            addModal.classList.remove('hidden');
            if (parentSelect) parentSelect.value = parentId ?? '';
            // ุฌูุจ ุงูููุฏ ุงูุชุงูู
            const url = '/chart-of-accounts/next-code?parent_id=' + (parentId ?? '');
            fetchJSON(url).then(d => {
                    if (codeInput) codeInput.value = d.nextCode;
                })
                .catch(() => {});
        }

        function closeModal() {
            if (!addModal || !addForm) return;
            addModal.classList.add('hidden');
            addForm.reset();
            accountTypeWrap?.classList.remove('hidden');
            natureWrap?.classList.add('hidden');
        }
        // ุฒุฑ ุฅุบูุงู (ูู ููุฌูุฏ)
        qsa('[data-close-modal="addAccountModal"]').forEach(b => on(b, 'click', closeModal));

        // ุฑุจุท ุฃุฒุฑุงุฑ + (ุฅุถุงูุฉ ุงุจู) ุฏุงุฎู ุงูุดุฌุฑุฉ
        function bindAddButtons(scope = document) {
            qsa('.add-account-btn', scope).forEach(btn => {
                on(btn, 'click', () => openModal(btn.dataset.parent));
            });
        }
        bindAddButtons();

        // ุชุจุฏูู ูุงุฌูุฉ ุงูููุน/ุงูุทุจูุนุฉ ุญุณุจ "ูุฌููุนุฉุ"
        function toggleTypeNatureFields() {
            const isGroup = isGroupCheckbox && isGroupCheckbox.checked;
            if (accountTypeWrap) accountTypeWrap.classList.toggle('hidden', isGroup);
            if (natureWrap) natureWrap.classList.toggle('hidden', !isGroup);
            if (!isGroup) syncNatureFromType();
        }

        function syncNatureFromType() {
            const opt = accountTypeSel?.options[accountTypeSel.selectedIndex];
            const n = opt ? opt.getAttribute('data-nature') : '';
            if (n && natureSel) natureSel.value = n;
        }
        on(isGroupCheckbox, 'change', toggleTypeNatureFields);
        on(accountTypeSel, 'change', syncNatureFromType);

        // ุนูุฏ ุชุบููุฑ ุงูุฃุจ ูู ุงูููุฏุงู โ ุญุฏูุซ ุงูููุฏ
        on(parentSelect, 'change', function() {
            const pid = this.value || '';
            fetchJSON('/chart-of-accounts/next-code?parent_id=' + pid)
                .then(d => {
                    if (codeInput) codeInput.value = d.nextCode;
                })
                .catch(() => {});
        });

        // ุญูุธ ุงูุญุณุงุจ ูู ุงูููุฏุงู (Ajax)
        on(addForm, 'submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(addForm);
            try {
                const res = await fetch("{{ route('chart-of-accounts.store-tree') }}", {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': getCsrf()
                    },
                    body: formData
                });
                const result = await res.json();
                if (!result.success) throw new Error('failed');
                alert('โ ุชู ุฅุถุงูุฉ ุงูุญุณุงุจ ุจูุฌุงุญ');
                closeModal();

                // ุฅุฏุฑุงุฌ ุงูุนูุฏุฉ ุงูุฌุฏูุฏุฉ ูู ุงูุดุฌุฑุฉ
                const a = result.account;
                const nodeHTML = `
<li data-id="${a.id}"
    data-code="${a.code||''}"
    data-name="${a.name||''}"
    data-desc="${(a.description||'').replace(/"/g,'&quot;')}"
    data-status="${a.status||''}"
    data-nature="${a.nature||''}"
    data-is_group="${a.is_group ? '1':'0'}"
    data-type_id="${a.account_type_id ?? ''}"
    data-currency_id="${a.currency_id ?? ''}"
    class="border-r pr-4 border-gray-300">
  <div class="flex items-center justify-between py-1">
    <div class="flex items-center" style="padding-right: ${((a.level||1)-1)*20}px;">
      <span class="mr-2 w-4 inline-block"></span>
      <span class="font-bold ${a.is_group ? 'text-gray-800' : 'text-purple-600'}">${a.code}</span>
      <span class="mr-2 ${a.is_group ? 'text-gray-800' : 'text-purple-700 font-semibold'}">${a.name}</span>
      <span class="mr-2 text-sm ${a.is_group ? 'text-gray-500' : 'text-purple-400'}">(${a.nature==='debit'?'ูุฏูู':'ุฏุงุฆู'})</span>
      <span class="mr-2 text-xs px-2 py-0.5 rounded-full ${a.status==='ูุดุท'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${a.status||''}</span>
    </div>
    <div class="flex items-center ml-auto pr-1 space-x-2 space-x-reverse">
      ${a.is_group ? `<button type="button" class="text-green-500 hover:text-green-700 text-sm add-account-btn" data-parent="${a.id}">
        <i class="fas fa-plus-circle"></i></button>` : ''}
      <a href="/chart-of-accounts/${a.id}/edit" class="text-blue-500 hover:text-blue-700 text-sm"><i class="fas fa-edit"></i></a>
      <form action="/chart-of-accounts/${a.id}" method="POST" class="inline" onsubmit="return confirm('ุชุฃููุฏ ุญุฐู ุงูุญุณุงุจุ')">
        <input type="hidden" name="_token" value="${getCsrf()}">
        <input type="hidden" name="_method" value="DELETE">
        <button type="submit" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash"></i></button>
      </form>
    </div>
  </div>
</li>`;

                if (a.parent_id) {
                    let parentUl = qs('#children-' + a.parent_id);
                    if (!parentUl) {
                        // ุฃูุดุฆ ูุงุฆูุฉ ุฃุจูุงุก ููุฃุจ ุฅู ูู ุชูุฌุฏ
                        const parentLi = qs(`li[data-id='${a.parent_id}']`);
                        if (parentLi) {
                            parentLi.insertAdjacentHTML('beforeend', `<ul id="children-${a.parent_id}" class="ml-6 mt-2 space-y-1 border-r pr-4 border-gray-200"></ul>`);
                            parentUl = qs('#children-' + a.parent_id);
                            // ุฃุถู ุฒุฑ toggle ููุฃุจ (ุฅู ูู ููู ููุฌูุฏูุง)
                            const btn = qs('.toggle-children', parentLi);
                            if (!btn) {
                                const titleDiv = qs('> .flex > .flex', parentLi);
                                if (titleDiv) {
                                    titleDiv.insertAdjacentHTML('afterbegin', `<button type="button" class="toggle-children text-gray-500 mr-2" data-target="children-${a.parent_id}">
                  <i class="fas fa-minus-square"></i></button>`);
                                }
                            }
                        }
                    }
                    parentUl?.insertAdjacentHTML('beforeend', nodeHTML);
                } else {
                    treeRootUl?.insertAdjacentHTML('beforeend', nodeHTML);
                }

                // ุฃุฑุจุท ุฃุฒุฑุงุฑ ุงูุนูุฏุฉ ุงููุถุงูุฉ
                const justAdded = qs(`li[data-id='${a.id}']`);
                bindNodeToggleButtons(justAdded);
                bindAddButtons(justAdded);

            } catch (err) {
                console.error(err);
                alert('ุชุนุฐุฑ ุฅุถุงูุฉ ุงูุญุณุงุจ. ุชุญูู ูู ุงูููู.');
            }
        });

        // ูุชุญ ุงูููุฏุงู ูู ุฃุฒุฑุงุฑ ููุฌูุฏุฉ ูุณุจููุง
        bindAddButtons();

        // ุชุจุฏูู ุงูุญููู ุฏุงุฎู ุงูููุฏุงู ูุจุฏุฆููุง
        toggleTypeNatureFields();
    });
</script>